<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        .response-box {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .dashboard-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .gauge-container {
            height: 200px;
        }
        .alert {
            display: none;
            margin-top: 10px;
        }
        .vehicle-status {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .status-indicator {
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            flex: 1;
            text-align: center;
            min-width: 150px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h2>Vahan-Rakshak Vehicle Monitoring Dashboard</h2>
        
        <!-- Vehicle Status Dashboard -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h4>Active Vehicle Status</h4>
                    <div class="vehicle-status">
                        <div class="status-indicator">
                            <h6>Active Vehicles</h6>
                            <span id="activeVehicles" class="h3">0</span>
                        </div>
                        <div class="status-indicator">
                            <h6>Total Alerts</h6>
                            <span id="totalAlerts" class="h3">0</span>
                        </div>
                        <div class="status-indicator">
                            <h6>Avg Speed</h6>
                            <span id="avgSpeed" class="h3">0 km/h</span>
                        </div>
                        <div class="status-indicator">
                            <h6>Fatigue Alerts</h6>
                            <span id="fatigueAlerts" class="h3">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Visualization -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h4>Driver Fatigue Metrics</h4>
                    <div class="chart-container">
                        <canvas id="fatigueChart"></canvas>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="eyeClosureValue">0%</div>
                            <div class="metric-label">Eye Closure</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="blinkDurationValue">0ms</div>
                            <div class="metric-label">Blink Duration</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="yawningRateValue">0</div>
                            <div class="metric-label">Yawns/min</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h4>Vehicle Speed Monitor</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="gauge-container">
                                <canvas id="speedGauge"></canvas>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-value" id="currentSpeedValue">0 km/h</div>
                                    <div class="metric-label">Current Speed</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="speedLimitValue">80 km/h</div>
                                    <div class="metric-label">Speed Limit</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="speedingDurationValue">0s</div>
                                    <div class="metric-label">Time Over Limit</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="speedHistoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Panel -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h4>Real-time Alerts</h4>
                    <div id="alertsPanel"></div>
                </div>
            </div>
        </div>

        <!-- Response Area -->
        <div class="mt-4">
            <h5>Last Response</h5>
            <pre class="response-box" id="responseArea">No response yet</pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let fatigueChart;
        let speedHistoryChart;
        let speedGauge;
        const maxDataPoints = 50;
        const vehicleData = new Map();

        function initFatigueChart() {
            const ctx = document.getElementById('fatigueChart').getContext('2d');
            fatigueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(maxDataPoints).fill(''),
                    datasets: [
                        {
                            label: 'Eye Closure %',
                            data: Array(maxDataPoints).fill(null),
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.4
                        },
                        {
                            label: 'Yawning Rate',
                            data: Array(maxDataPoints).fill(null),
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 100
                        }
                    },
                    animation: false
                }
            });
        }

        function initSpeedGauge() {
            const ctx = document.getElementById('speedGauge').getContext('2d');
            speedGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['rgb(75, 192, 192)', 'rgb(232, 232, 232)'],
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '85%',
                    plugins: {
                        tooltip: { enabled: false },
                        legend: { display: false }
                    }
                }
            });
        }

        function initSpeedHistoryChart() {
            const ctx = document.getElementById('speedHistoryChart').getContext('2d');
            speedHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(maxDataPoints).fill(''),
                    datasets: [
                        {
                            label: 'Vehicle Speed',
                            data: Array(maxDataPoints).fill(null),
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 100
                        }
                    },
                    animation: false
                }
            });
        }

        let ws;
        const WS_URL = 'ws://localhost:8001/ws/vehicle_data/';
        const RECONNECT_DELAY = 2000; // 2 seconds

        function initWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = function() {
                console.log("WebSocket connected.");
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);

                if (message.type === 'driver_data') {
                    handleDriverData(message.data);
                }
                if (message.type === 'speed_data') {
                    handleSpeedData(message.data);
                }
                if (message.type === 'connection_established') {
                    console.log("Connection established at", message.timestamp);
                }
            };

            ws.onerror = function(err) {
                console.error("WebSocket error:", err);
            };

            ws.onclose = function(event) {
                console.warn(`WebSocket closed (code: ${event.code}). Reconnecting in ${RECONNECT_DELAY/1000}s...`);
                setTimeout(initWebSocket, RECONNECT_DELAY); // auto-reconnect
            };
        }

        function handleDriverData(data) {
            document.getElementById('eyeClosureValue').textContent = `${(data.eye_closure_pct || 0).toFixed(1)}%`;
            document.getElementById('blinkDurationValue').textContent = `${data.blink_duration_ms || 0}ms`;
            document.getElementById('yawningRateValue').textContent = (data.yawning_rate_per_min || 0).toFixed(1);

            updateDashboard(data.vehicle_id, data);
            updateCharts(data);
        }

        function handleSpeedData(data) {
            const currentSpeed = data.current_speed_kmh || 0;
            const speedLimit = data.speed_limit_kmh || 80;

            document.getElementById('currentSpeedValue').textContent = `${currentSpeed} km/h`;
            document.getElementById('speedLimitValue').textContent = `${speedLimit} km/h`;
            
            if (data.speeding_duration_sec !== undefined) {
                document.getElementById('speedingDurationValue').textContent = `${data.speeding_duration_sec}s`;
            }

            updateDashboard(data.vehicle_id, data);
            updateCharts(data);
        }

        function updateDashboard(vehicleId, data) {
            const speed = data.current_speed_kmh || 0;

            if (!vehicleData.has(vehicleId)) {
                vehicleData.set(vehicleId, { speed, lastUpdate: Date.now() });
            } else {
                vehicleData.get(vehicleId).speed = speed;
                vehicleData.get(vehicleId).lastUpdate = Date.now();
            }

            const activeCount = [...vehicleData.values()]
                .filter(v => Date.now() - v.lastUpdate < 10000).length;

            document.getElementById('activeVehicles').textContent = activeCount;

            const avgSpeed = [...vehicleData.values()].reduce((sum, v) => sum + v.speed, 0) / vehicleData.size;
            document.getElementById('avgSpeed').textContent = `${avgSpeed.toFixed(1)} km/h`;
        }

        function updateCharts(data) {
            if (data.eye_closure_pct !== undefined) {
                fatigueChart.data.datasets[0].data.push(data.eye_closure_pct);
                fatigueChart.data.datasets[0].data.shift();
                fatigueChart.update();
            }

            if (data.yawning_rate_per_min !== undefined) {
                fatigueChart.data.datasets[1].data.push(data.yawning_rate_per_min);
                fatigueChart.data.datasets[1].data.shift();
                fatigueChart.update();
            }

            if (data.current_speed_kmh !== undefined) {
                const speedPercent = (data.current_speed_kmh / (data.speed_limit_kmh || 80)) * 100;
                speedGauge.data.datasets[0].data = [speedPercent, 100 - speedPercent];
                speedGauge.update();

                speedHistoryChart.data.datasets[0].data.push(data.current_speed_kmh);
                speedHistoryChart.data.datasets[0].data.shift();
                speedHistoryChart.update();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initFatigueChart();
            initSpeedGauge();
            initSpeedHistoryChart();
            initWebSocket();
        });
    </script>
</body>
</html>
